<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Intuitive Care</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 p-8">

<div id="app" class="max-w-6xl mx-auto">

    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-blue-600">üìä Monitoramento de Despesas ANS</h1>
        <p class="text-gray-600 mt-2">Visualiza√ß√£o de dados financeiros das operadoras</p>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Top 5 Estados com Maiores Despesas</h2>
        <div class="relative h-64 w-full">
            <canvas id="meuGrafico"></canvas>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl font-semibold text-gray-700">Detalhes das Operadoras</h2>

            <div class="w-full md:w-1/2">
                <input type="text" v-model="busca" @input="buscarDados"
                       placeholder="üîé Buscar por Raz√£o Social ou CNPJ..."
                       class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-gray-600">
                <thead class="bg-blue-50 text-blue-700 uppercase font-medium">
                <tr>
                    <th class="px-4 py-3">Registro ANS</th>
                    <th class="px-4 py-3">CNPJ</th>
                    <th class="px-4 py-3">Raz√£o Social</th>
                    <th class="px-4 py-3">UF</th>
                    <th class="px-4 py-3 text-right">Valor Total</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="item in lista" :key="item.RegistroANS" class="border-b hover:bg-gray-50 transition">
                    <td class="px-4 py-3 font-medium">{{ item.RegistroANS }}</td>
                    <td class="px-4 py-3">{{ item.CNPJ }}</td>
                    <td class="px-4 py-3">{{ item.RazaoSocial }}</td>
                    <td class="px-4 py-3">{{ item.UF }}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-600">R$ {{ item.ValorDespesas }}</td>
                </tr>

                <tr v-if="lista.length === 0">
                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                        Nenhum dado encontrado. Verifique se a API Python est√° rodando.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="flex justify-between items-center mt-6">
            <button @click="mudarPagina(-1)" :disabled="pagina === 1"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                ‚¨Ö Anterior
            </button>

            <span class="text-gray-600 font-medium">P√°gina {{ pagina }}</span>

            <button @click="mudarPagina(1)" :disabled="lista.length < limite"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Pr√≥xima ‚û°
            </button>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        // DATA: √â a "mem√≥ria" da p√°gina. Tudo que muda na tela fica aqui.
        data() {
            return {
                lista: [],          // Onde guardamos as operadoras que v√™m da API
                busca: '',          // O que o usu√°rio digitou na busca
                pagina: 1,          // P√°gina atual
                limite: 10,         // Quantos itens por p√°gina
                chartInstance: null // Guarda o gr√°fico pra poder atualizar depois
            }
        },
        // METHODS: S√£o as fun√ß√µes/a√ß√µes que a p√°gina pode fazer
        methods: {
            // Fun√ß√£o 1: Bater na API Python e pegar a lista de operadoras
            async buscarDados() {
                try {
                    // Faz a requisi√ß√£o HTTP GET para o nosso Python (main.py)
                    // Passa a p√°gina atual, o limite e o texto da busca
                    const response = await fetch(`http://127.0.0.1:8000/api/operadoras?page=${this.pagina}&limit=${this.limite}&busca=${this.busca}`);
                    const json = await response.json();

                    // Atualiza a lista na tela
                    this.lista = json.data;
                } catch (error) {
                    console.error("Erro na API:", error);
                    // N√£o colocamos alert() pra n√£o ficar chato pro usu√°rio, s√≥ loga no console.
                }
            },

            // Fun√ß√£o 2: Bater na API Python e pegar os dados do gr√°fico
            async carregarGrafico() {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/estatisticas');
                    const json = await response.json();

                    // Pega o elemento <canvas> do HTML
                    const ctx = document.getElementById('meuGrafico');

                    // Se j√° tinha um gr√°fico antes, destr√≥i ele pra n√£o bugar (ficar um por cima do outro)
                    if (this.chartInstance) this.chartInstance.destroy();

                    // Cria o gr√°fico novo
                    this.chartInstance = new Chart(ctx, {
                        type: 'bar', // Gr√°fico de Barras
                        data: {
                            labels: json.labels, // Ex: ["SP", "RJ", "MG"]
                            datasets: [{
                                label: 'Despesas Totais (R$)',
                                data: json.values, // Os valores em dinheiro
                                backgroundColor: 'rgba(59, 130, 246, 0.6)', // Azul bonit√£o
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } } // Esconde a legenda pq j√° tem t√≠tulo
                        }
                    });
                } catch (error) {
                    console.error("Erro no gr√°fico:", error);
                }
            },

            // Fun√ß√£o 3: Controla os bot√µes "Anterior" e "Pr√≥xima"
            mudarPagina(direcao) {
                this.pagina += direcao;
                this.buscarDados(); // Recarrega a lista com a nova p√°gina
            }
        },
        // MOUNTED: Roda automaticamente assim que a tela abre
        mounted() {
            // J√° busca os dados iniciais pra tela n√£o ficar em branco
            this.buscarDados();
            this.carregarGrafico();
        }
    }).mount('#app'); // Monta o Vue na div com id="app"
</script>
</body>
</html>